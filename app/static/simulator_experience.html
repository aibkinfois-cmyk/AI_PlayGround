<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>AI ì¸í”„ë¼ë¹„ì„œ ì¥ì• ì•Œë¦¼ì²´í—˜</title>
  <style>
    :root{
      --bg: #f0f7ff;
      --card: #ffffff;
      --ink: #0f172a;
      --muted:#475569;
      --primary:#0046ff;
      --primary-2:#0033cc;
      --accent:#22c55e;
      --border:#d1e3f8;
      --warning:#ef4444;
      --warning-bg:#fff5f5;
      --warning-border:#fecaca;
      --shinhan-blue:#0046ff;
      --shinhan-light:#e6f0ff;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:linear-gradient(180deg,#e6f0ff,#ffffff);font-family:ui-sans-serif,system-ui,Segoe UI,Roboto,Apple Color Emoji,Noto Color Emoji; color:var(--ink)}
    .container{max-width:1100px;margin:0 auto;padding:24px}
    h1{margin:0;font-size:28px;color:var(--shinhan-blue)}
    .sub{color:var(--muted);font-size:14px;margin-top:6px}
    .brand{display:inline-block;padding:4px 12px;background:var(--shinhan-blue);color:#fff;border-radius:6px;font-size:12px;font-weight:700;margin-bottom:8px}
    
    /* Alert Box */
    .alert-box{
      background:linear-gradient(135deg, #e6f0ff 0%, #f0f7ff 100%);
      border:2px solid var(--shinhan-blue);
      border-radius:16px;
      padding:20px;
      margin:24px 0;
      box-shadow:0 4px 12px rgba(0,70,255,0.1);
    }
    .alert-box h2{
      margin:0 0 12px;
      font-size:18px;
      color:var(--shinhan-blue);
      display:flex;
      align-items:center;
      gap:8px;
      font-weight:700;
    }
    .alert-box p{
      margin:8px 0;
      line-height:1.6;
    }
    .alert-box .note{
      font-size:12px;
      color:var(--shinhan-blue);
      font-weight:600;
      margin-top:12px;
      background:#fff;
      padding:8px 12px;
      border-radius:8px;
      border-left:3px solid var(--shinhan-blue);
    }
    
    /* User Input Form */
    .user-form{
      background:rgba(255,255,255,.9);
      backdrop-filter:saturate(120%) blur(2px);
      border:1px solid var(--border);
      border-radius:22px;
      padding:24px;
      margin:24px 0;
    }
    .user-form h3{
      margin:0 0 16px;
      font-size:16px;
    }
    .form-group{
      margin-bottom:16px;
    }
    .form-group label{
      display:block;
      font-size:14px;
      font-weight:600;
      margin-bottom:6px;
      color:var(--ink);
    }
    .form-group input{
      width:100%;
      padding:10px 14px;
      border:1px solid var(--border);
      border-radius:12px;
      font-size:14px;
      font-family:inherit;
    }
    .form-group input:focus{
      outline:none;
      border-color:var(--primary);
      box-shadow:0 0 0 3px rgba(79,70,229,0.1);
    }
    .form-group .hint{
      font-size:12px;
      color:var(--muted);
      margin-top:4px;
    }
    
    .controls{display:flex;gap:12px;flex-wrap:wrap;align-items:center;margin-top:16px}
    .btn{border:1px solid var(--border);background:#fff;padding:10px 16px;border-radius:12px;font-size:14px;cursor:pointer;display:inline-flex;align-items:center;gap:8px;font-weight:600}
    .btn.primary{background:var(--primary);color:#fff;border-color:var(--primary)}
    .btn.primary:hover{background:var(--primary-2)}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    select{padding:8px 12px;border-radius:12px;border:1px solid var(--border);font-size:14px;background:#fff}
    
    .grid{display:grid;grid-template-columns:1fr;gap:16px;margin-top:20px}
    @media(min-width:960px){.grid{grid-template-columns:1fr 1fr}}
    .panel{background:rgba(255,255,255,.8);backdrop-filter:saturate(120%) blur(2px);border:1px solid var(--border);border-radius:22px;padding:18px}
    .panel h3{margin:0 0 12px;font-size:16px;display:flex;align-items:center;gap:8px}
    .steps{display:flex;flex-direction:column;gap:8px}
    .step{border:1px solid var(--border);border-radius:18px;padding:12px 14px;display:flex;align-items:flex-start;gap:12px;background:#fff;position:relative}
    .step.active{background:linear-gradient(90deg,#e6f0ff,#f0f7ff);border-color:#0046ff;box-shadow:0 4px 10px rgba(0,70,255,0.12)}
    .step.done{background:linear-gradient(90deg,#ecfdf5,#f0fdf4);border-color:#6ee7b7}
    .step.skipped{opacity:.6}
    .dot{width:18px;height:18px;border-radius:50%;background:#cbd5e1;flex:0 0 auto;margin-top:2px}
    .step.active .dot{background:#0046ff;animation:pulse 1s infinite}
    .step.done .dot{background:#22c55e}
    @keyframes pulse{0%{transform:scale(1)}50%{transform:scale(1.15)}100%{transform:scale(1)}}
    .title{font-weight:600;font-size:14px}
    .subtxt{font-size:12px;color:var(--muted);margin-top:4px}
    .divider{width:2px;height:16px;background:linear-gradient(#e2e8f0,transparent);margin:8px auto}
    .logs{background:#001a4d;color:#e5e7eb;border-radius:18px;border:2px solid #0046ff;height:540px;overflow:auto;padding:14px;font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;font-size:12px;white-space:pre-wrap}
    .logline{line-height:1.6}
    .logtag{color:#6bb3ff}
    .muted{color:var(--muted);font-size:12px}
    footer{margin:28px 0;text-align:center;color:#94a3b8;font-size:12px}
    .icon{width:18px;height:18px}
    .error-msg{color:#ef4444;font-size:13px;margin-top:8px;display:none}
  </style>
</head>
<body>
  <div class="container">
    <span class="brand">SHINHAN DS</span>
    <h1>AI ì¸í”„ë¼ë¹„ì„œ ì¥ì• ì•Œë¦¼ì²´í—˜</h1>
    <div class="sub">ì‹¤ì œ ê¸´ê¸‰ ì¥ì•  ì•Œë¦¼ ì‹œìŠ¤í…œì„ ì²´í—˜í•´ë³´ì„¸ìš”.</div>

    <div class="alert-box">
      <h2>
        <svg class="icon" fill="currentColor" viewBox="0 0 20 20">
          <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
        </svg>
        ê¸´ê¸‰ ìƒí™© ë°œìƒ
      </h2>
      <p><strong>ë‹¹ì‹ ì€ ì‹ í•œDS ì„œë²„ ë‹´ë‹¹ìì…ë‹ˆë‹¤.</strong></p>
      <p>í˜„ì¬ <strong>ë‹¨ìœ„DB ì„œë²„ ë‹¤ìš´ Critical</strong> ë©”ì‹œì§€ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</p>
      <p>ì •ë‹´ë‹¹ìì˜ ì„±ëª… ë° íœ´ëŒ€í° ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì—¬, ì‹œë®¬ë ˆì´ì…˜ì„ ì‹œì‘í•´ì£¼ì„¸ìš”.</p>
      <p class="note">*í•´ë‹¹ ë²ˆí˜¸ë¡œ ì „í™”ê°€ ìˆ˜ì‹ ë©ë‹ˆë‹¤. (ë¶€ë‹´ë‹¹ìëŠ” ì„ íƒì‚¬í•­)</p>
    </div>

    <div class="user-form">
      <h3>ë‹´ë‹¹ì ì •ë³´ ì…ë ¥</h3>
      
      <div style="background:linear-gradient(135deg, #e6f0ff 0%, #f0f7ff 100%);border:2px solid #0046ff;border-radius:12px;padding:16px;margin-bottom:20px;box-shadow:0 2px 8px rgba(0,70,255,0.08)">
        <h4 style="margin:0 0 12px;font-size:14px;color:#0046ff;font-weight:700">ì •ë‹´ë‹¹ì (Primary Contact)</h4>
        <div class="form-group" style="margin-bottom:12px">
          <label for="primaryName">ì„±ëª…</label>
          <input type="text" id="primaryName" placeholder="í™ê¸¸ë™" />
          <div class="hint">ì •ë‹´ë‹¹ì ì„±ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.</div>
        </div>
        <div class="form-group" style="margin-bottom:0">
          <label for="primaryPhone">íœ´ëŒ€í° ë²ˆí˜¸</label>
          <input type="tel" id="primaryPhone" placeholder="010-1234-5678" maxlength="13" class="phone-input" />
          <div class="hint">'-' í¬í•¨í•˜ì—¬ ì…ë ¥í•´ì£¼ì„¸ìš”. (ì˜ˆ: 010-1234-5678)</div>
        </div>
      </div>
      
      <div style="background:#f0f7ff;border:1px solid #a7c7ff;border-radius:12px;padding:16px;position:relative">
        <h4 style="margin:0 0 12px;font-size:14px;color:#0046ff">ë¶€ë‹´ë‹¹ì (Secondary Contact) <span style="color:#94a3b8;font-size:12px;font-weight:400">- ì„ íƒì‚¬í•­</span></h4>
        <div class="form-group" style="margin-bottom:12px">
          <label for="secondaryName">ì„±ëª… <span style="color:#94a3b8;font-weight:400">(ì„ íƒ)</span></label>
          <input type="text" id="secondaryName" placeholder="ê¹€ì² ìˆ˜ (ì„ íƒì‚¬í•­)" />
          <div class="hint">ë¶€ë‹´ë‹¹ìê°€ ìˆëŠ” ê²½ìš° ì…ë ¥í•´ì£¼ì„¸ìš”.</div>
        </div>
        <div class="form-group" style="margin-bottom:0">
          <label for="secondaryPhone">íœ´ëŒ€í° ë²ˆí˜¸ <span style="color:#94a3b8;font-weight:400">(ì„ íƒ)</span></label>
          <input type="tel" id="secondaryPhone" placeholder="010-9876-5432 (ì„ íƒì‚¬í•­)" maxlength="13" class="phone-input" />
          <div class="hint">ë¶€ë‹´ë‹¹ìê°€ ìˆëŠ” ê²½ìš° ì…ë ¥í•´ì£¼ì„¸ìš”.</div>
        </div>
      </div>
      
      <div class="error-msg" id="errorMsg">ì •ë‹´ë‹¹ì ì •ë³´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.</div>
    </div>

    <div class="controls">
      <label class="muted">ì‹œë®¬ë ˆì´ì…˜ ì†ë„</label>
      <select id="speed">
        <option value="fast">ë¹ ë¥´ê²Œ</option>
        <option value="normal" selected>ë³´í†µ</option>
        <option value="slow">ëŠë¦¬ê²Œ</option>
      </select>
      <button id="reset" class="btn">â†» ë¦¬ì…‹</button>
      <button id="start" class="btn primary">â–¶ ì‹œë®¬ë ˆì´ì…˜ ì‹œì‘</button>
    </div>

    <div class="grid">
      <div class="panel">
        <h3>ê¸´ê¸‰ ì „íŒŒ ì›Œí¬í”Œë¡œìš°</h3>
        <div id="steps" class="steps"></div>
      </div>

      <div class="panel">
        <h3>ì‹¤ì‹œê°„ ì‹œë®¬ë ˆì´ì…˜ ë¡œê·¸</h3>
        <div id="logs" class="logs"><div class="muted">ì‹œë®¬ë ˆì´ì…˜ ë¡œê·¸ê°€ ì—¬ê¸°ì— ì¶œë ¥ë©ë‹ˆë‹¤â€¦</div></div>
      </div>
    </div>

    <footer>Â© <span id="year"></span> SHINHAN DS Â· AI ì¸í”„ë¼ë¹„ì„œ ì¥ì• ì•Œë¦¼ì²´í—˜ Â· Demo Simulator</footer>
  </div>

<script>
(function(){
  const $ = (sel)=>document.querySelector(sel);
  const $$ = (sel)=>Array.from(document.querySelectorAll(sel));
  const sleep = (ms)=>new Promise(r=>setTimeout(r,ms));

  const SPEED = { fast:320, normal:700, slow:1200 };
  const API_BASE_URL = window.location.origin;  // ë™ì ìœ¼ë¡œ í˜„ì¬ ì„œë²„ ì‚¬ìš©

  const STEPS_EMERGENCY = [
    { title:"START: ì´ë²¤íŠ¸ ìˆ˜ì‹  (API Webhook)"},
    { title:"LLM ë¶„ì„: ë©”ì‹œì§€ ìš”ì•½ ë° ì‹¬ê°ë„ ì¬íŒë‹¨"},
    { title:"ì‹¬ê°ë„ íŒë‹¨: Critical/Major ì¸ê°€?"},
    { title:"ITSM ì—°ë™: ë‹´ë‹¹ì ì¡°íšŒ"},
    { title:"PDS/TTS ì—°ë™: ê¸´ê¸‰ ìŒì„± í†µë³´"},
    { title:"Reporting: ê²°ê³¼ ê¸°ë¡"},
    { title:"END"}
  ];

  let running = false;
  let lines = [];
  let realCallMode = true;  // ì‹¤ì œ ì „í™” ëª¨ë“œ
  let startTime = null;  // ì‹œë®¬ë ˆì´ì…˜ ì‹œì‘ ì‹œê°„

  const $steps = $("#steps");
  const $logs = $("#logs");
  const $speed = $("#speed");
  const $start = $("#start");
  const $reset = $("#reset");
  const $primaryName = $("#primaryName");
  const $primaryPhone = $("#primaryPhone");
  const $secondaryName = $("#secondaryName");
  const $secondaryPhone = $("#secondaryPhone");
  const $errorMsg = $("#errorMsg");

  // init
  $("#year").textContent = new Date().getFullYear();

  // Phone number formatting for all phone inputs
  function formatPhoneNumber(e){
    let val = e.target.value.replace(/[^0-9]/g, '');
    if(val.length <= 3) {
      e.target.value = val;
    } else if(val.length <= 7) {
      e.target.value = val.slice(0,3) + '-' + val.slice(3);
    } else if(val.length <= 11) {
      e.target.value = val.slice(0,3) + '-' + val.slice(3,7) + '-' + val.slice(7);
    } else {
      e.target.value = val.slice(0,3) + '-' + val.slice(3,7) + '-' + val.slice(7,11);
    }
  }
  
  $$('.phone-input').forEach(input => {
    input.oninput = formatPhoneNumber;
  });

  function renderSteps(){
    $steps.innerHTML = "";
    STEPS_EMERGENCY.forEach((s,i)=>{
      const el = document.createElement("div");
      el.className = "step";
      el.innerHTML = `<div class="dot"></div>
        <div><div class="title">${i+1}. ${s.title}</div>
        ${s.subtitle?`<div class="subtxt">${s.subtitle}</div>`:""}</div>`;
      $steps.appendChild(el);
      if(i<STEPS_EMERGENCY.length-1){ 
        const div = document.createElement("div"); 
        div.className="divider"; 
        $steps.appendChild(div); 
      }
    });
  }

  function setStepStatus(idx, status){
    const stepEls = $$(".step");
    const el = stepEls[idx];
    if(!el) return;
    el.classList.remove("idle","active","done","skipped");
    el.classList.add(status);
  }

  function pushLog(text, timestamp){
    if(lines.length===0) $logs.innerHTML = "";
    lines.push(text);
    const div = document.createElement("div");
    div.className="logline";
    const timeStr = timestamp ? ` <span style="color:#94a3b8;font-size:11px">[${timestamp}]</span>` : '';
    div.innerHTML = `<span class="logtag">[Step ${lines.length}]</span> ${text}${timeStr}`;
    $logs.appendChild(div);
    $logs.scrollTop = $logs.scrollHeight;
  }

  function reset(){
    running = false; 
    lines = [];
    renderSteps();
    $logs.innerHTML = '<div class="muted">ì‹œë®¬ë ˆì´ì…˜ ë¡œê·¸ê°€ ì—¬ê¸°ì— ì¶œë ¥ë©ë‹ˆë‹¤â€¦</div>';
    $errorMsg.style.display = 'none';
  }

  function validateInputs(){
    const primaryName = $primaryName.value.trim();
    const primaryPhone = $primaryPhone.value.trim();
    const secondaryName = $secondaryName.value.trim();
    const secondaryPhone = $secondaryPhone.value.trim();
    const phoneRegex = /^010-\d{4}-\d{4}$/;
    
    // ì •ë‹´ë‹¹ìëŠ” í•„ìˆ˜
    if(!primaryName || !primaryPhone){
      $errorMsg.textContent = 'ì •ë‹´ë‹¹ì ì •ë³´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.';
      $errorMsg.style.display = 'block';
      return false;
    }
    
    if(!phoneRegex.test(primaryPhone)){
      $errorMsg.textContent = 'ì •ë‹´ë‹¹ì íœ´ëŒ€í° ë²ˆí˜¸ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤. (ì˜ˆ: 010-1234-5678)';
      $errorMsg.style.display = 'block';
      return false;
    }
    
    // ë¶€ë‹´ë‹¹ìëŠ” ì„ íƒì‚¬í•­ì´ì§€ë§Œ, ì…ë ¥í–ˆë‹¤ë©´ ìœ íš¨ì„± ê²€ì‚¬
    if(secondaryName || secondaryPhone){
      if(!secondaryName || !secondaryPhone){
        $errorMsg.textContent = 'ë¶€ë‹´ë‹¹ì ì •ë³´ë¥¼ ì…ë ¥í•˜ë ¤ë©´ ì„±ëª…ê³¼ íœ´ëŒ€í° ë²ˆí˜¸ë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.';
        $errorMsg.style.display = 'block';
        return false;
      }
      
      if(!phoneRegex.test(secondaryPhone)){
        $errorMsg.textContent = 'ë¶€ë‹´ë‹¹ì íœ´ëŒ€í° ë²ˆí˜¸ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤. (ì˜ˆ: 010-1234-5678)';
        $errorMsg.style.display = 'block';
        return false;
      }
      
      if(primaryPhone === secondaryPhone){
        $errorMsg.textContent = 'ì •ë‹´ë‹¹ìì™€ ë¶€ë‹´ë‹¹ìì˜ íœ´ëŒ€í° ë²ˆí˜¸ê°€ ë™ì¼í•©ë‹ˆë‹¤. ë‹¤ë¥¸ ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.';
        $errorMsg.style.display = 'block';
        return false;
      }
    }
    
    $errorMsg.style.display = 'none';
    return true;
  }

  // ì „í™”ë²ˆí˜¸ í˜•ì‹ ë³€í™˜ (010-1234-5678 â†’ +821012345678)
  function convertToE164(phone) {
    if(!phone) return null;
    // 010-1234-5678 â†’ +821012345678
    return '+82' + phone.replace(/^0/, '').replace(/-/g, '');
  }

  // ë¡œê·¸ ë¼ì¸ì„ ì—…ë°ì´íŠ¸ (ê¸°ì¡´ ë¼ì¸ ìˆ˜ì •)
  function updateLastLog(text, timestamp){
    const logLines = $$(".logline");
    if(logLines.length > 0){
      const lastLine = logLines[logLines.length - 1];
      const currentStepNumber = lines.length;
      const timeStr = timestamp ? ` <span style="color:#94a3b8;font-size:11px">[${timestamp}]</span>` : '';
      lastLine.innerHTML = `<span class="logtag">[Step ${currentStepNumber}]</span> ${text}${timeStr}`;
      // lines ë°°ì—´ì˜ ë§ˆì§€ë§‰ í•­ëª©ë„ ì—…ë°ì´íŠ¸
      lines[lines.length - 1] = text;
    }
  }

  async function callRealAPI(primaryName, primaryPhone, secondaryName, secondaryPhone){
    return new Promise((resolve, reject) => {
      try {
        const payload = {
          primary_name: primaryName,
          primary_phone: convertToE164(primaryPhone),
          secondary_name: secondaryName || null,
          secondary_phone: secondaryPhone ? convertToE164(secondaryPhone) : null,
          incident_summary: "ë‹¨ìœ„DB ì„œë²„ ë‹¤ìš´ Critical",
          tts_text: "[ê¸´ê¸‰] ë‹¨ìœ„DB ì„œë²„ì— Critical ì¥ì• ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì‹ í•œDS ì„œë²„ ë‹´ë‹¹ìëŠ” ì¦‰ì‹œ í™•ì¸ ë¶€íƒë“œë¦½ë‹ˆë‹¤."
        };
        
        // "API ì—°ê²° ì¤‘..." ë¡œê·¸ ì œê±° (ìš”ì²­ì‚¬í•­ 4ë²ˆ)
        
        const eventSource = new EventSource(`${API_BASE_URL}/simulator/call`);
        let callResults = [];
        let completed = false;
        
        // POST ë°ì´í„°ë¥¼ ì „ì†¡í•˜ê¸° ìœ„í•´ fetch ì‚¬ìš©
        fetch(`${API_BASE_URL}/simulator/call`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Accept': 'text/event-stream'
          },
          body: JSON.stringify(payload)
        }).then(response => {
          if(!response.ok){
            throw new Error(`API ì˜¤ë¥˜: ${response.status}`);
          }
          
          const reader = response.body.getReader();
          const decoder = new TextDecoder();
          
          function readStream(){
            reader.read().then(({done, value}) => {
              if(done){
                if(!completed){
                  pushLog("ğŸ”” ì „í™” ë°œì‹  í”„ë¡œì„¸ìŠ¤ ì™„ë£Œ");
                  resolve({success: true, calls: callResults});
                }
                return;
              }
              
              const text = decoder.decode(value);
              const lines = text.split('\n');
              
              for(const line of lines){
                if(line.startsWith('data: ')){
                  try {
                    const data = JSON.parse(line.substring(6));
                    handleSSEEvent(data, callResults);
                    
                    if(data.type === 'escalation_complete' || data.type === 'escalation_failed'){
                      completed = true;
                      resolve({success: true, calls: callResults});
                      return;
                    }
                  } catch(e){
                    console.error('SSE parse error:', e);
                  }
                }
              }
              
              readStream();
            }).catch(error => {
              pushLog(`âš ï¸ ì—°ê²° ì˜¤ë¥˜: ${error.message}`);
              reject(error);
            });
          }
          
          readStream();
        }).catch(error => {
          pushLog(`âš ï¸ API í˜¸ì¶œ ì‹¤íŒ¨: ${error.message}`);
          pushLog(`ğŸ’¡ ì„œë²„ê°€ ì‹¤í–‰ ì¤‘ì¸ì§€ í™•ì¸í•´ì£¼ì„¸ìš”: ${API_BASE_URL}`);
          reject(error);
        });
        
      } catch(error) {
        pushLog(`âš ï¸ ì˜¤ë¥˜ ë°œìƒ: ${error.message}`);
        reject(error);
      }
    });
  }

  function handleSSEEvent(data, callResults){
    switch(data.type){
      case 'call_start':
        pushLog(`ğŸ“ ${data.role} ${data.name} (${data.phone}): ë°œì‹ ì¤‘...`, data.timestamp);
        break;
      
      case 'call_initiated':
        updateLastLog(`ğŸ“ ${data.role || 'ë‹´ë‹¹ì'}: í˜¸ì¶œ ì‹œì‘ (Call ID: ${data.call_id})`, data.timestamp);
        break;
      
      case 'call_answered':
        updateLastLog(`âœ… ${data.name}: ì „í™” ì—°ê²° ì„±ê³µ! (í†µí™”ì‹œê°„: ${data.duration}ì´ˆ)`, data.timestamp);
        callResults.push({name: data.name, status: 'answered', duration: data.duration});
        break;
      
      case 'call_failed':
        updateLastLog(`âŒ ${data.name}: ì „í™” ì—°ê²° ì‹¤íŒ¨ (${data.reason})`, data.timestamp);
        callResults.push({name: data.name, status: 'failed', reason: data.reason});
        break;
      
      case 'call_error':
        updateLastLog(`âš ï¸ ${data.name}: ì˜¤ë¥˜ ë°œìƒ - ${data.error}`, data.timestamp);
        callResults.push({name: data.name, status: 'error', error: data.error});
        break;
      
      case 'escalation_complete':
        pushLog(`ğŸ‰ ì—ìŠ¤ì»¬ë ˆì´ì…˜ ì„±ê³µ: ${data.answered_by}ë‹˜ì´ ì „í™”ë¥¼ ë°›ì•˜ìŠµë‹ˆë‹¤.`, data.timestamp);
        pushLog(`   ì´ ì‹œë„ íšŸìˆ˜: ${data.total_attempts}íšŒ`);
        break;
      
      case 'escalation_failed':
        pushLog(`âš ï¸ ì—ìŠ¤ì»¬ë ˆì´ì…˜ ì‹¤íŒ¨: ëª¨ë“  ë‹´ë‹¹ìê°€ ì „í™”ë¥¼ ë°›ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.`, data.timestamp);
        pushLog(`   ì´ ì‹œë„ íšŸìˆ˜: ${data.total_attempts}íšŒ`);
        break;
      
      case 'error':
        pushLog(`âš ï¸ ì‹œìŠ¤í…œ ì˜¤ë¥˜: ${data.message}`, data.timestamp);
        break;
    }
  }

  async function runEmergency(){
    if(running) return;
    
    if(!validateInputs()) return;
    
    reset(); 
    running = true;
    startTime = Date.now();  // ì‹œì‘ ì‹œê°„ ê¸°ë¡
    
    const primaryName = $primaryName.value.trim();
    const primaryPhone = $primaryPhone.value.trim();
    const secondaryName = $secondaryName.value.trim();
    const secondaryPhone = $secondaryPhone.value.trim();
    const delay = SPEED[$speed.value] || SPEED.normal;

    // 0
    setStepStatus(0,"active");
    pushLog(`NMS ìˆ˜ì‹  â†’ system='ë‹¨ìœ„DB ì„œë²„', severity='Critical'`);
    await sleep(delay); setStepStatus(0,"done");

    // 1
    setStepStatus(1,"active");
    pushLog("LLM ë¶„ì„â€¦ ìš”ì•½/ì •ê·œí™” ì§„í–‰.");
    pushLog(`ìš”ì•½: "ë‹¨ìœ„DB ì„œë²„ ë‹¤ìš´, ì„œë¹„ìŠ¤ ì˜í–¥ Critical"`);
    await sleep(delay); setStepStatus(1,"done");

    // 2
    setStepStatus(2,"active");
    pushLog(`ì¡°ê±´ íŒë‹¨: ê¸´ê¸‰ ê²½ë¡œ(YES) - Critical ì¥ì•  ê°ì§€`);
    await sleep(delay); setStepStatus(2,"done");

    // 3
    setStepStatus(3,"active"); 
    pushLog(`ITSM ì˜¨ì½œ ì¡°íšŒâ€¦ ì •ë‹´ë‹¹ì: ${primaryName} / ${primaryPhone}`);
    if(secondaryName && secondaryPhone){
      pushLog(`ITSM ì˜¨ì½œ ì¡°íšŒâ€¦ ë¶€ë‹´ë‹¹ì: ${secondaryName} / ${secondaryPhone}`);
    } else {
      pushLog(`ë¶€ë‹´ë‹¹ì: ë¯¸ì§€ì • (ì •ë‹´ë‹¹ìë§Œ ì•Œë¦¼ ë°œì†¡)`);
    }
    await sleep(delay); setStepStatus(3,"done");
    
    // 4 - ì‹¤ì œ API í˜¸ì¶œ (ì‹¤ì‹œê°„ ì—ìŠ¤ì»¬ë ˆì´ì…˜)
    setStepStatus(4,"active"); 
    pushLog(`[ì‹¤ì œ ì „í™” ë°œì‹ ] ìˆœì°¨ ì—ìŠ¤ì»¬ë ˆì´ì…˜ ì‹œì‘`);
    
    let apiResult = null;
    try {
      apiResult = await callRealAPI(primaryName, primaryPhone, secondaryName, secondaryPhone);
      
      // SSEë¡œ ì´ë¯¸ ëª¨ë“  ë¡œê·¸ê°€ ì¶œë ¥ë˜ì—ˆìŒ
      // apiResultëŠ” ìµœì¢… ê²°ê³¼ë§Œ í¬í•¨
      
      if(apiResult && apiResult.success){
        // ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œ
        await sleep(300);
      } else {
        pushLog("âš ï¸ ì „í™” ë°œì‹  í”„ë¡œì„¸ìŠ¤ ì¤‘ë‹¨");
      }
    } catch(error) {
      pushLog(`âš ï¸ ì—ëŸ¬: ${error.message}`);
    }
    
    setStepStatus(4,"done");
    
    // 5
    setStepStatus(5,"active"); 
    pushLog("Reporting ì €ì¥ ì™„ë£Œ - ì¥ì•  ì•Œë¦¼ ì´ë ¥ ê¸°ë¡");
    await sleep(delay); setStepStatus(5,"done");

    // 6
    setStepStatus(6,"active"); 
    pushLog("ê¸´ê¸‰ ì•Œë¦¼ ì›Œí¬í”Œë¡œìš° ì¢…ë£Œ");
    
    // ì‹¤ì œ ê²½ê³¼ ì‹œê°„ ê³„ì‚°
    const elapsedTime = ((Date.now() - startTime) / 1000).toFixed(1);
    pushLog(`ì´ ì²˜ë¦¬ ì‹œê°„: ${elapsedTime}ì´ˆ`);
    
    await sleep(Math.max(260, (delay/2)|0)); 
    setStepStatus(6,"done");
    running = false;
  }

  // wire events
  $reset.onclick = ()=> reset();
  $start.onclick = ()=> runEmergency();

  // first render
  renderSteps();
})();
</script>
</body>
</html>

