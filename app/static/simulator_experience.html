<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>AI 인프라비서 장애알림체험</title>
  <style>
    :root{
      --bg: #f0f7ff;
      --card: #ffffff;
      --ink: #0f172a;
      --muted:#475569;
      --primary:#0046ff;
      --primary-2:#0033cc;
      --accent:#22c55e;
      --border:#d1e3f8;
      --warning:#ef4444;
      --warning-bg:#fff5f5;
      --warning-border:#fecaca;
      --shinhan-blue:#0046ff;
      --shinhan-light:#e6f0ff;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:linear-gradient(180deg,#e6f0ff,#ffffff);font-family:ui-sans-serif,system-ui,Segoe UI,Roboto,Apple Color Emoji,Noto Color Emoji; color:var(--ink)}
    .container{max-width:1100px;margin:0 auto;padding:24px}
    h1{margin:0;font-size:28px;color:var(--shinhan-blue)}
    .sub{color:var(--muted);font-size:14px;margin-top:6px}
    .brand{display:inline-block;padding:4px 12px;background:var(--shinhan-blue);color:#fff;border-radius:6px;font-size:12px;font-weight:700;margin-bottom:8px}
    
    /* Alert Box */
    .alert-box{
      background:linear-gradient(135deg, #e6f0ff 0%, #f0f7ff 100%);
      border:2px solid var(--shinhan-blue);
      border-radius:16px;
      padding:20px;
      margin:24px 0;
      box-shadow:0 4px 12px rgba(0,70,255,0.1);
    }
    .alert-box h2{
      margin:0 0 12px;
      font-size:18px;
      color:var(--shinhan-blue);
      display:flex;
      align-items:center;
      gap:8px;
      font-weight:700;
    }
    .alert-box p{
      margin:8px 0;
      line-height:1.6;
    }
    .alert-box .note{
      font-size:12px;
      color:var(--shinhan-blue);
      font-weight:600;
      margin-top:12px;
      background:#fff;
      padding:8px 12px;
      border-radius:8px;
      border-left:3px solid var(--shinhan-blue);
    }
    
    /* User Input Form */
    .user-form{
      background:rgba(255,255,255,.9);
      backdrop-filter:saturate(120%) blur(2px);
      border:1px solid var(--border);
      border-radius:22px;
      padding:24px;
      margin:24px 0;
    }
    .user-form h3{
      margin:0 0 16px;
      font-size:16px;
    }
    .form-group{
      margin-bottom:16px;
    }
    .form-group label{
      display:block;
      font-size:14px;
      font-weight:600;
      margin-bottom:6px;
      color:var(--ink);
    }
    .form-group input{
      width:100%;
      padding:10px 14px;
      border:1px solid var(--border);
      border-radius:12px;
      font-size:14px;
      font-family:inherit;
    }
    .form-group input:focus{
      outline:none;
      border-color:var(--primary);
      box-shadow:0 0 0 3px rgba(79,70,229,0.1);
    }
    .form-group .hint{
      font-size:12px;
      color:var(--muted);
      margin-top:4px;
    }
    
    .controls{display:flex;gap:12px;flex-wrap:wrap;align-items:center;margin-top:16px}
    .btn{border:1px solid var(--border);background:#fff;padding:10px 16px;border-radius:12px;font-size:14px;cursor:pointer;display:inline-flex;align-items:center;gap:8px;font-weight:600}
    .btn.primary{background:var(--primary);color:#fff;border-color:var(--primary)}
    .btn.primary:hover{background:var(--primary-2)}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    select{padding:8px 12px;border-radius:12px;border:1px solid var(--border);font-size:14px;background:#fff}
    
    .grid{display:grid;grid-template-columns:1fr;gap:16px;margin-top:20px}
    @media(min-width:960px){.grid{grid-template-columns:1fr 1fr}}
    .panel{background:rgba(255,255,255,.8);backdrop-filter:saturate(120%) blur(2px);border:1px solid var(--border);border-radius:22px;padding:18px}
    .panel h3{margin:0 0 12px;font-size:16px;display:flex;align-items:center;gap:8px}
    .steps{display:flex;flex-direction:column;gap:8px}
    .step{border:1px solid var(--border);border-radius:18px;padding:12px 14px;display:flex;align-items:flex-start;gap:12px;background:#fff;position:relative}
    .step.active{background:linear-gradient(90deg,#e6f0ff,#f0f7ff);border-color:#0046ff;box-shadow:0 4px 10px rgba(0,70,255,0.12)}
    .step.done{background:linear-gradient(90deg,#ecfdf5,#f0fdf4);border-color:#6ee7b7}
    .step.skipped{opacity:.6}
    .dot{width:18px;height:18px;border-radius:50%;background:#cbd5e1;flex:0 0 auto;margin-top:2px}
    .step.active .dot{background:#0046ff;animation:pulse 1s infinite}
    .step.done .dot{background:#22c55e}
    @keyframes pulse{0%{transform:scale(1)}50%{transform:scale(1.15)}100%{transform:scale(1)}}
    .title{font-weight:600;font-size:14px}
    .subtxt{font-size:12px;color:var(--muted);margin-top:4px}
    .divider{width:2px;height:16px;background:linear-gradient(#e2e8f0,transparent);margin:8px auto}
    .logs{background:#001a4d;color:#e5e7eb;border-radius:18px;border:2px solid #0046ff;height:540px;overflow:auto;padding:14px;font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;font-size:12px;white-space:pre-wrap}
    .logline{line-height:1.6}
    .logtag{color:#6bb3ff}
    .muted{color:var(--muted);font-size:12px}
    footer{margin:28px 0;text-align:center;color:#94a3b8;font-size:12px}
    .icon{width:18px;height:18px}
    .error-msg{color:#ef4444;font-size:13px;margin-top:8px;display:none}
  </style>
</head>
<body>
  <div class="container">
    <span class="brand">SHINHAN DS</span>
    <h1>AI 인프라비서 장애알림체험</h1>
    <div class="sub">실제 긴급 장애 알림 시스템을 체험해보세요.</div>

    <div class="alert-box">
      <h2>
        <svg class="icon" fill="currentColor" viewBox="0 0 20 20">
          <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
        </svg>
        긴급 상황 발생
      </h2>
      <p><strong>당신은 신한DS 서버 담당자입니다.</strong></p>
      <p>현재 <strong>단위DB 서버 다운 Critical</strong> 메시지가 발생했습니다.</p>
      <p>정담당자의 성명 및 휴대폰 번호를 입력하여, 시뮬레이션을 시작해주세요.</p>
      <p class="note">*해당 번호로 전화가 수신됩니다. (부담당자는 선택사항)</p>
    </div>

    <div class="user-form">
      <h3>담당자 정보 입력</h3>
      
      <div style="background:linear-gradient(135deg, #e6f0ff 0%, #f0f7ff 100%);border:2px solid #0046ff;border-radius:12px;padding:16px;margin-bottom:20px;box-shadow:0 2px 8px rgba(0,70,255,0.08)">
        <h4 style="margin:0 0 12px;font-size:14px;color:#0046ff;font-weight:700">정담당자 (Primary Contact)</h4>
        <div class="form-group" style="margin-bottom:12px">
          <label for="primaryName">성명</label>
          <input type="text" id="primaryName" placeholder="홍길동" />
          <div class="hint">정담당자 성명을 입력해주세요.</div>
        </div>
        <div class="form-group" style="margin-bottom:0">
          <label for="primaryPhone">휴대폰 번호</label>
          <input type="tel" id="primaryPhone" placeholder="010-1234-5678" maxlength="13" class="phone-input" />
          <div class="hint">'-' 포함하여 입력해주세요. (예: 010-1234-5678)</div>
        </div>
      </div>
      
      <div style="background:#f0f7ff;border:1px solid #a7c7ff;border-radius:12px;padding:16px;position:relative">
        <h4 style="margin:0 0 12px;font-size:14px;color:#0046ff">부담당자 (Secondary Contact) <span style="color:#94a3b8;font-size:12px;font-weight:400">- 선택사항</span></h4>
        <div class="form-group" style="margin-bottom:12px">
          <label for="secondaryName">성명 <span style="color:#94a3b8;font-weight:400">(선택)</span></label>
          <input type="text" id="secondaryName" placeholder="김철수 (선택사항)" />
          <div class="hint">부담당자가 있는 경우 입력해주세요.</div>
        </div>
        <div class="form-group" style="margin-bottom:0">
          <label for="secondaryPhone">휴대폰 번호 <span style="color:#94a3b8;font-weight:400">(선택)</span></label>
          <input type="tel" id="secondaryPhone" placeholder="010-9876-5432 (선택사항)" maxlength="13" class="phone-input" />
          <div class="hint">부담당자가 있는 경우 입력해주세요.</div>
        </div>
      </div>
      
      <div class="error-msg" id="errorMsg">정담당자 정보를 입력해주세요.</div>
    </div>

    <div class="controls">
      <label class="muted">시뮬레이션 속도</label>
      <select id="speed">
        <option value="fast">빠르게</option>
        <option value="normal" selected>보통</option>
        <option value="slow">느리게</option>
      </select>
      <button id="reset" class="btn">↻ 리셋</button>
      <button id="start" class="btn primary">▶ 시뮬레이션 시작</button>
    </div>

    <div class="grid">
      <div class="panel">
        <h3>긴급 전파 워크플로우</h3>
        <div id="steps" class="steps"></div>
      </div>

      <div class="panel">
        <h3>실시간 시뮬레이션 로그</h3>
        <div id="logs" class="logs"><div class="muted">시뮬레이션 로그가 여기에 출력됩니다…</div></div>
      </div>
    </div>

    <footer>© <span id="year"></span> SHINHAN DS · AI 인프라비서 장애알림체험 · Demo Simulator</footer>
  </div>

<script>
(function(){
  const $ = (sel)=>document.querySelector(sel);
  const $$ = (sel)=>Array.from(document.querySelectorAll(sel));
  const sleep = (ms)=>new Promise(r=>setTimeout(r,ms));

  const SPEED = { fast:320, normal:700, slow:1200 };
  const API_BASE_URL = window.location.origin;  // 동적으로 현재 서버 사용

  const STEPS_EMERGENCY = [
    { title:"START: 이벤트 수신 (API Webhook)"},
    { title:"LLM 분석: 메시지 요약 및 심각도 재판단"},
    { title:"심각도 판단: Critical/Major 인가?"},
    { title:"ITSM 연동: 담당자 조회"},
    { title:"PDS/TTS 연동: 긴급 음성 통보"},
    { title:"Reporting: 결과 기록"},
    { title:"END"}
  ];

  let running = false;
  let lines = [];
  let realCallMode = true;  // 실제 전화 모드
  let startTime = null;  // 시뮬레이션 시작 시간

  const $steps = $("#steps");
  const $logs = $("#logs");
  const $speed = $("#speed");
  const $start = $("#start");
  const $reset = $("#reset");
  const $primaryName = $("#primaryName");
  const $primaryPhone = $("#primaryPhone");
  const $secondaryName = $("#secondaryName");
  const $secondaryPhone = $("#secondaryPhone");
  const $errorMsg = $("#errorMsg");

  // init
  $("#year").textContent = new Date().getFullYear();

  // Phone number formatting for all phone inputs
  function formatPhoneNumber(e){
    let val = e.target.value.replace(/[^0-9]/g, '');
    if(val.length <= 3) {
      e.target.value = val;
    } else if(val.length <= 7) {
      e.target.value = val.slice(0,3) + '-' + val.slice(3);
    } else if(val.length <= 11) {
      e.target.value = val.slice(0,3) + '-' + val.slice(3,7) + '-' + val.slice(7);
    } else {
      e.target.value = val.slice(0,3) + '-' + val.slice(3,7) + '-' + val.slice(7,11);
    }
  }
  
  $$('.phone-input').forEach(input => {
    input.oninput = formatPhoneNumber;
  });

  function renderSteps(){
    $steps.innerHTML = "";
    STEPS_EMERGENCY.forEach((s,i)=>{
      const el = document.createElement("div");
      el.className = "step";
      el.innerHTML = `<div class="dot"></div>
        <div><div class="title">${i+1}. ${s.title}</div>
        ${s.subtitle?`<div class="subtxt">${s.subtitle}</div>`:""}</div>`;
      $steps.appendChild(el);
      if(i<STEPS_EMERGENCY.length-1){ 
        const div = document.createElement("div"); 
        div.className="divider"; 
        $steps.appendChild(div); 
      }
    });
  }

  function setStepStatus(idx, status){
    const stepEls = $$(".step");
    const el = stepEls[idx];
    if(!el) return;
    el.classList.remove("idle","active","done","skipped");
    el.classList.add(status);
  }

  function pushLog(text, timestamp){
    if(lines.length===0) $logs.innerHTML = "";
    lines.push(text);
    const div = document.createElement("div");
    div.className="logline";
    const timeStr = timestamp ? ` <span style="color:#94a3b8;font-size:11px">[${timestamp}]</span>` : '';
    div.innerHTML = `<span class="logtag">[Step ${lines.length}]</span> ${text}${timeStr}`;
    $logs.appendChild(div);
    $logs.scrollTop = $logs.scrollHeight;
  }

  function reset(){
    running = false; 
    lines = [];
    renderSteps();
    $logs.innerHTML = '<div class="muted">시뮬레이션 로그가 여기에 출력됩니다…</div>';
    $errorMsg.style.display = 'none';
  }

  function validateInputs(){
    const primaryName = $primaryName.value.trim();
    const primaryPhone = $primaryPhone.value.trim();
    const secondaryName = $secondaryName.value.trim();
    const secondaryPhone = $secondaryPhone.value.trim();
    const phoneRegex = /^010-\d{4}-\d{4}$/;
    
    // 정담당자는 필수
    if(!primaryName || !primaryPhone){
      $errorMsg.textContent = '정담당자 정보를 입력해주세요.';
      $errorMsg.style.display = 'block';
      return false;
    }
    
    if(!phoneRegex.test(primaryPhone)){
      $errorMsg.textContent = '정담당자 휴대폰 번호 형식이 올바르지 않습니다. (예: 010-1234-5678)';
      $errorMsg.style.display = 'block';
      return false;
    }
    
    // 부담당자는 선택사항이지만, 입력했다면 유효성 검사
    if(secondaryName || secondaryPhone){
      if(!secondaryName || !secondaryPhone){
        $errorMsg.textContent = '부담당자 정보를 입력하려면 성명과 휴대폰 번호를 모두 입력해주세요.';
        $errorMsg.style.display = 'block';
        return false;
      }
      
      if(!phoneRegex.test(secondaryPhone)){
        $errorMsg.textContent = '부담당자 휴대폰 번호 형식이 올바르지 않습니다. (예: 010-1234-5678)';
        $errorMsg.style.display = 'block';
        return false;
      }
      
      if(primaryPhone === secondaryPhone){
        $errorMsg.textContent = '정담당자와 부담당자의 휴대폰 번호가 동일합니다. 다른 번호를 입력해주세요.';
        $errorMsg.style.display = 'block';
        return false;
      }
    }
    
    $errorMsg.style.display = 'none';
    return true;
  }

  // 전화번호 형식 변환 (010-1234-5678 → +821012345678)
  function convertToE164(phone) {
    if(!phone) return null;
    // 010-1234-5678 → +821012345678
    return '+82' + phone.replace(/^0/, '').replace(/-/g, '');
  }

  // 로그 라인을 업데이트 (기존 라인 수정)
  function updateLastLog(text, timestamp){
    const logLines = $$(".logline");
    if(logLines.length > 0){
      const lastLine = logLines[logLines.length - 1];
      const currentStepNumber = lines.length;
      const timeStr = timestamp ? ` <span style="color:#94a3b8;font-size:11px">[${timestamp}]</span>` : '';
      lastLine.innerHTML = `<span class="logtag">[Step ${currentStepNumber}]</span> ${text}${timeStr}`;
      // lines 배열의 마지막 항목도 업데이트
      lines[lines.length - 1] = text;
    }
  }

  async function callRealAPI(primaryName, primaryPhone, secondaryName, secondaryPhone){
    return new Promise((resolve, reject) => {
      try {
        const payload = {
          primary_name: primaryName,
          primary_phone: convertToE164(primaryPhone),
          secondary_name: secondaryName || null,
          secondary_phone: secondaryPhone ? convertToE164(secondaryPhone) : null,
          incident_summary: "단위DB 서버 다운 Critical",
          tts_text: "[긴급] 단위DB 서버에 Critical 장애가 발생했습니다. 신한DS 서버 담당자는 즉시 확인 부탁드립니다."
        };
        
        // "API 연결 중..." 로그 제거 (요청사항 4번)
        
        const eventSource = new EventSource(`${API_BASE_URL}/simulator/call`);
        let callResults = [];
        let completed = false;
        
        // POST 데이터를 전송하기 위해 fetch 사용
        fetch(`${API_BASE_URL}/simulator/call`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Accept': 'text/event-stream'
          },
          body: JSON.stringify(payload)
        }).then(response => {
          if(!response.ok){
            throw new Error(`API 오류: ${response.status}`);
          }
          
          const reader = response.body.getReader();
          const decoder = new TextDecoder();
          
          function readStream(){
            reader.read().then(({done, value}) => {
              if(done){
                if(!completed){
                  pushLog("🔔 전화 발신 프로세스 완료");
                  resolve({success: true, calls: callResults});
                }
                return;
              }
              
              const text = decoder.decode(value);
              const lines = text.split('\n');
              
              for(const line of lines){
                if(line.startsWith('data: ')){
                  try {
                    const data = JSON.parse(line.substring(6));
                    handleSSEEvent(data, callResults);
                    
                    if(data.type === 'escalation_complete' || data.type === 'escalation_failed'){
                      completed = true;
                      resolve({success: true, calls: callResults});
                      return;
                    }
                  } catch(e){
                    console.error('SSE parse error:', e);
                  }
                }
              }
              
              readStream();
            }).catch(error => {
              pushLog(`⚠️ 연결 오류: ${error.message}`);
              reject(error);
            });
          }
          
          readStream();
        }).catch(error => {
          pushLog(`⚠️ API 호출 실패: ${error.message}`);
          pushLog(`💡 서버가 실행 중인지 확인해주세요: ${API_BASE_URL}`);
          reject(error);
        });
        
      } catch(error) {
        pushLog(`⚠️ 오류 발생: ${error.message}`);
        reject(error);
      }
    });
  }

  function handleSSEEvent(data, callResults){
    switch(data.type){
      case 'call_start':
        pushLog(`📞 ${data.role} ${data.name} (${data.phone}): 발신중...`, data.timestamp);
        break;
      
      case 'call_initiated':
        updateLastLog(`📞 ${data.role || '담당자'}: 호출 시작 (Call ID: ${data.call_id})`, data.timestamp);
        break;
      
      case 'call_answered':
        updateLastLog(`✅ ${data.name}: 전화 연결 성공! (통화시간: ${data.duration}초)`, data.timestamp);
        callResults.push({name: data.name, status: 'answered', duration: data.duration});
        break;
      
      case 'call_failed':
        updateLastLog(`❌ ${data.name}: 전화 연결 실패 (${data.reason})`, data.timestamp);
        callResults.push({name: data.name, status: 'failed', reason: data.reason});
        break;
      
      case 'call_error':
        updateLastLog(`⚠️ ${data.name}: 오류 발생 - ${data.error}`, data.timestamp);
        callResults.push({name: data.name, status: 'error', error: data.error});
        break;
      
      case 'escalation_complete':
        pushLog(`🎉 에스컬레이션 성공: ${data.answered_by}님이 전화를 받았습니다.`, data.timestamp);
        pushLog(`   총 시도 횟수: ${data.total_attempts}회`);
        break;
      
      case 'escalation_failed':
        pushLog(`⚠️ 에스컬레이션 실패: 모든 담당자가 전화를 받지 않았습니다.`, data.timestamp);
        pushLog(`   총 시도 횟수: ${data.total_attempts}회`);
        break;
      
      case 'error':
        pushLog(`⚠️ 시스템 오류: ${data.message}`, data.timestamp);
        break;
    }
  }

  async function runEmergency(){
    if(running) return;
    
    if(!validateInputs()) return;
    
    reset(); 
    running = true;
    startTime = Date.now();  // 시작 시간 기록
    
    const primaryName = $primaryName.value.trim();
    const primaryPhone = $primaryPhone.value.trim();
    const secondaryName = $secondaryName.value.trim();
    const secondaryPhone = $secondaryPhone.value.trim();
    const delay = SPEED[$speed.value] || SPEED.normal;

    // 0
    setStepStatus(0,"active");
    pushLog(`NMS 수신 → system='단위DB 서버', severity='Critical'`);
    await sleep(delay); setStepStatus(0,"done");

    // 1
    setStepStatus(1,"active");
    pushLog("LLM 분석… 요약/정규화 진행.");
    pushLog(`요약: "단위DB 서버 다운, 서비스 영향 Critical"`);
    await sleep(delay); setStepStatus(1,"done");

    // 2
    setStepStatus(2,"active");
    pushLog(`조건 판단: 긴급 경로(YES) - Critical 장애 감지`);
    await sleep(delay); setStepStatus(2,"done");

    // 3
    setStepStatus(3,"active"); 
    pushLog(`ITSM 온콜 조회… 정담당자: ${primaryName} / ${primaryPhone}`);
    if(secondaryName && secondaryPhone){
      pushLog(`ITSM 온콜 조회… 부담당자: ${secondaryName} / ${secondaryPhone}`);
    } else {
      pushLog(`부담당자: 미지정 (정담당자만 알림 발송)`);
    }
    await sleep(delay); setStepStatus(3,"done");
    
    // 4 - 실제 API 호출 (실시간 에스컬레이션)
    setStepStatus(4,"active"); 
    pushLog(`[실제 전화 발신] 순차 에스컬레이션 시작`);
    
    let apiResult = null;
    try {
      apiResult = await callRealAPI(primaryName, primaryPhone, secondaryName, secondaryPhone);
      
      // SSE로 이미 모든 로그가 출력되었음
      // apiResult는 최종 결과만 포함
      
      if(apiResult && apiResult.success){
        // 성공적으로 완료
        await sleep(300);
      } else {
        pushLog("⚠️ 전화 발신 프로세스 중단");
      }
    } catch(error) {
      pushLog(`⚠️ 에러: ${error.message}`);
    }
    
    setStepStatus(4,"done");
    
    // 5
    setStepStatus(5,"active"); 
    pushLog("Reporting 저장 완료 - 장애 알림 이력 기록");
    await sleep(delay); setStepStatus(5,"done");

    // 6
    setStepStatus(6,"active"); 
    pushLog("긴급 알림 워크플로우 종료");
    
    // 실제 경과 시간 계산
    const elapsedTime = ((Date.now() - startTime) / 1000).toFixed(1);
    pushLog(`총 처리 시간: ${elapsedTime}초`);
    
    await sleep(Math.max(260, (delay/2)|0)); 
    setStepStatus(6,"done");
    running = false;
  }

  // wire events
  $reset.onclick = ()=> reset();
  $start.onclick = ()=> runEmergency();

  // first render
  renderSteps();
})();
</script>
</body>
</html>

